# Google Calendar MCP Server Example

A standalone, runnable example demonstrating how to build a real-world MCP (Model Context Protocol) server that uses the KeyCard OAuth SDK for delegated token exchange to access Google Calendar on behalf of authenticated users.

> **📋 Development Status**: This example is fully structured as a production-ready package. Some dependencies (`keycardai-oauth`, `fastmcp`) are commented out in `pyproject.toml` until those packages are available. See `SETUP_NOTES.md` for details on enabling full functionality.

## Overview

This example shows how to:
- Use the unified KeyCard OAuth client for clean token exchange
- Implement a real-world Google Calendar integration via token exchange
- Handle Google Calendar API requests with proper error handling
- Structure calendar event data with Pydantic models
- Build a production-ready MCP server with comprehensive features

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   MCP Client    │───▶│   MCP Server     │───▶│  STS Service    │
│                 │    │  (This Example)  │    │                 │
│ User's Token    │    │                  │    │ Token Exchange  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │  Target APIs    │
                       │  (Google, etc.) │
                       └─────────────────┘
```

## Key Benefits vs Manual Implementation

**❌ Manual Implementation Problems:**
- Complex token parsing with error-prone base64 handling
- Custom HTTP client code for STS communication  
- Manual request/response serialization
- Inconsistent error handling across operations
- Difficult to test and maintain

**✅ Unified STS Client Benefits:**
- One-line token extraction: `extract_bearer_token(auth_header)`
- Simple client setup: `Client("https://auth.example.com")`
- Automatic request/response handling
- Consistent error handling and retry logic
- Easy testing with mock clients
- Enterprise-ready authentication strategies



## Package Structure

```
delegated_token_exchange/
├── pyproject.toml              # Project configuration and dependencies
├── README.md                   # This documentation  
├── LICENSE                     # MIT license
├── .gitignore                  # Git ignore rules
├── uv.lock                     # Locked dependencies (generated by uv)
├── src/
│   └── delegated_token_exchange/
│       ├── __init__.py        # Package initialization
│       ├── __main__.py        # Module entry point
│       ├── server.py          # Main MCP server implementation
│       └── config.py          # Configuration management
└── integration-helpers/        # Framework helpers (belongs in keycardai-oauth-fastmcp)
    ├── README.md              # Integration package explanation
    └── fastmcp_helpers.py     # FastMCP-specific helpers

## Quick Start

### Prerequisites
- Python 3.9+ 
- [uv](https://github.com/astral-sh/uv) installed

### Installation & Setup

```bash
# Clone or download this example
git clone <repo> && cd delegated_token_exchange

# Install dependencies with uv
uv sync

# Copy environment template and configure
cp .env.example .env
# Edit .env with your configuration values

# Run the server  
uv run python -m delegated_token_exchange

# Or using the installed script
uv run mcp-calendar-server

# Or activate virtual environment and run directly
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
python -m delegated_token_exchange
```

### Development Setup

```bash
# Install with development dependencies
uv sync --dev

# Run tests
uv run pytest

# Format code
uv run black src/
uv run isort src/

# Type checking  
uv run mypy src/

# Linting
uv run ruff check src/
```

## Configuration

Configure the server by setting environment variables in your `.env` file:

```bash
# STS Service Configuration
STS_BASE_URL="https://api.your-keycard-instance.com"
CLIENT_ID="mcp-server-client"
CLIENT_SECRET="your-client-secret-here"

# JWT Token Verification  
JWKS_URI="https://auth.your-keycard-instance.com/.well-known/jwks"
ISSUER="https://auth.your-keycard-instance.com"
AUDIENCE="http://localhost:8000/mcp"

# Server Configuration
HOST="localhost"
PORT="8000"
```

See `.env.example` for a complete configuration template with detailed comments.

## Code Examples

### **Google Calendar Integration**
```python
@mcp.tool()
async def get_calendar_events(
    ctx: Context,
    maxResults: int = 10,
    timeMin: Optional[str] = None,
    timeMax: Optional[str] = None,
    calendarId: str = "primary"
) -> Dict[str, Any]:
    """Get Google Calendar events for the authenticated user."""
    # Extract user token from request context
    request = ctx.get_http_request()
    user_token = extract_bearer_token(request.headers.get("Authorization", ""))
    
    # Exchange token for Google Calendar access
    token_response = await oauth_client.token_exchange(
        subject_token=user_token,
        audience="https://www.googleapis.com",
        scope="https://www.googleapis.com/auth/calendar.readonly"
    )
    
    # Call Google Calendar API directly
    calendar_events = await fetch_google_calendar_events(
        access_token=token_response.access_token,
        calendar_id=calendarId,
        max_results=maxResults,
        time_min=timeMin,
        time_max=timeMax
    )
    
    return {
        "events": [event.dict() for event in calendar_events],
        "totalEvents": len(calendar_events)
    }
```

### **Tool Usage Example**
```bash
# Get upcoming calendar events (default: next 7 days, max 10 events)
curl -X POST http://localhost:8000/mcp/call \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "method": "get_calendar_events",
    "params": {
      "maxResults": 5,
      "timeMin": "2024-01-15T00:00:00Z",
      "timeMax": "2024-01-22T00:00:00Z"
    }
  }'
```

### **Framework Integration Helpers** (Future: `keycardai-oauth-fastmcp`)
```python
# These would be in a separate integration package
from keycardai.oauth.integrations.fastmcp import TokenExchangeHelper

helper = TokenExchangeHelper(oauth_client)

@mcp.tool()
async def get_google_token(ctx: Context) -> str:
    return await helper.google_api_token(ctx)  # One-liner with integration package
```

## Integration Notes

This example is designed to work with:
- **KeyCard OAuth SDK Phase 1**: Basic token exchange functionality
- **FastMCP**: For MCP server framework  
- **Any OAuth 2.0 Identity Provider**: Supporting JWT tokens and token exchange

**Note**: This example demonstrates a complete, real-world use case of delegated token exchange, showing how to integrate with external APIs (Google Calendar) while maintaining clean separation between the core OAuth SDK and application-specific logic.
