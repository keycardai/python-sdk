---
title: "FastMCP Integration"
description: "How to use KeyCard OAuth with FastMCP servers for automated token exchange"
---

# FastMCP Integration

Simple examples showing how to use KeyCard OAuth components with FastMCP for automated token exchange.

## Installation

```bash
uv add keycardai-mcp-fastmcp keycardai-oauth fastmcp
```

## Core Components

### 1. KeyCard Auth Provider

Handles JWT authentication and user verification:

```python
from keycardai.mcp.integrations.fastmcp import KeycardAuthProvider

auth_provider = KeycardAuthProvider(
    zone_url="https://your-zone.keycard.cloud",
    mcp_server_name="My Server",
    mcp_server_url="https://your-server.com/mcp"
)
```

### 2. OAuth Client Middleware

Manages OAuth client registration and token exchange:

```python
from keycardai.mcp.integrations.fastmcp import OAuthClientMiddleware

oauth_middleware = OAuthClientMiddleware(
    zone_url="https://your-zone.keycard.cloud"
)
```

### 3. Token Exchange Decorator

Automatically exchanges user tokens for resource-specific tokens:

```python
# Single integration - clean and simple
from keycardai.mcp.integrations.fastmcp import get_access_token_for_resource

@get_access_token_for_resource("https://api.example.com")
async def my_tool(ctx: Context):
    # ctx.access_token contains the exchanged token
    return {"token": ctx.access_token}

```

**Why this approach is best:**

- ✅ **Clean decorator usage**: No namespace objects cluttering the decorator
- ✅ **Flexible aliasing**: Use `import as` to handle conflicts when needed
- ✅ **Pythonic**: Follows standard Python import patterns
- ✅ **IDE-friendly**: Better autocomplete and type hints

## Basic Server Setup

```python
from fastmcp import FastMCP, Context
from keycardai.mcp.integrations.fastmcp import (
    KeycardAuthProvider,
    OAuthClientMiddleware,
    get_access_token_for_resource
)
import httpx

# Create MCP server
mcp = FastMCP("My Server")

# Add authentication
auth_provider = KeycardAuthProvider(
    zone_url="https://your-zone.keycard.cloud",
    mcp_server_name="My Server",
    mcp_server_url="https://your-server.com/mcp"
)
mcp.add_auth_provider(auth_provider)

# Add OAuth middleware
oauth_middleware = OAuthClientMiddleware(
    zone_url="https://your-zone.keycard.cloud"
)
mcp.add_middleware(oauth_middleware)

# Define tool with automatic token exchange
@mcp.tool()
@get_access_token_for_resource("https://www.googleapis.com/calendar/v3")
async def get_calendar_events(ctx: Context, maxResults: int = 10) -> dict:
    """Get user's calendar events."""
    async with httpx.AsyncClient() as client:
        response = await client.get(
            "https://www.googleapis.com/calendar/v3/calendars/primary/events",
            headers={"Authorization": f"Bearer {ctx.access_token}"},
            params={"maxResults": maxResults}
        )
        response.raise_for_status()
        return response.json()

# Run server
if __name__ == "__main__":
    mcp.run(transport="http", port=8000, path="/mcp")
```

## Configuration

Set environment variables:

```bash
export ZONE_URL="https://your-zone.keycard.cloud"
export MCP_SERVER_URL="https://your-server.com/mcp"
export MCP_SERVER_NAME="My Server"
```

## Multiple Resource Access

Access different APIs with separate decorators:

```python
@mcp.tool()
@get_access_token_for_resource("https://www.googleapis.com/calendar/v3")
async def get_calendar(ctx: Context):
    return {"calendar_token": ctx.access_token}

@mcp.tool()
@get_access_token_for_resource("https://www.googleapis.com/drive/v3")
async def get_drive_files(ctx: Context):
    return {"drive_token": ctx.access_token}
```

## Error Handling

```python
from keycardai.oauth import OAuthError

@mcp.tool()
@get_access_token_for_resource("https://api.example.com")
async def api_call(ctx: Context):
    try:
        # Your API call here
        async with httpx.AsyncClient() as client:
            response = await client.get(
                "https://api.example.com/data",
                headers={"Authorization": f"Bearer {ctx.access_token}"}
            )
            response.raise_for_status()
            return response.json()
    except OAuthError as e:
        return {"error": f"OAuth error: {e}"}
    except Exception as e:
        return {"error": f"API error: {e}"}
```

