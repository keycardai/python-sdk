---
title: "Token Exchange"
description: "How to exchange tokens using OAuth 2.0 Token Exchange (RFC 8693)"
---

# Token Exchange

This example demonstrates how to use OAuth 2.0 Token Exchange (RFC 8693) to exchange one token for another, enabling secure token delegation and impersonation scenarios.

## Basic Token Exchange

```python
from keycardai.oauth import Client

def exchange_token():
    with Client("https://zoneid.keycard.cloud") as client:
        access_token = client.get_access_token_for_resource(
            "https://google.api/calendar/v3", 
            "user_access_token"
        )
        print(f"Access Token: {access_token}")
        return access_token

# Run the token exchange
new_token = exchange_token()
```

## Async Basic Token Exchange

```python
from keycardai.oauth import AsyncClient

async def async_exchange_token():
    async with AsyncClient("https://zoneid.keycard.cloud") as client:
        access_token = await client.get_access_token_for_resource(
            "https://google.api/calendar/v3", 
            "user_access_token"
        )
        print(f"Access Token: {access_token}")
        return access_token

# Run the async token exchange
import asyncio
new_token = asyncio.run(async_exchange_token())
```

## Token Delegation

Request access to different resources:

```python
from keycardai.oauth import Client

def delegate_token():
    with Client("https://zoneid.keycard.cloud") as client:
        # Request access to Google Drive API
        drive_token = client.get_access_token_for_resource(
            "https://www.googleapis.com/auth/drive", 
            "user_access_token"
        )
        print(f"Drive Access Token: {drive_token}")
        
        # Request access to Slack API  
        slack_token = client.get_access_token_for_resource(
            "https://slack.com/api", 
            "user_access_token"
        )
        print(f"Slack Access Token: {slack_token}")
        
        return drive_token, slack_token

# Run delegation
drive_token, slack_token = delegate_token()
```

## Async Token Delegation

```python
from keycardai.oauth import AsyncClient

async def async_delegate_token():
    async with AsyncClient("https://zoneid.keycard.cloud") as client:
        # Request access to Google Drive API
        drive_token = await client.get_access_token_for_resource(
            "https://www.googleapis.com/auth/drive", 
            "user_access_token"
        )
        print(f"Drive Access Token: {drive_token}")
        
        # Request access to Slack API  
        slack_token = await client.get_access_token_for_resource(
            "https://slack.com/api", 
            "user_access_token"
        )
        print(f"Slack Access Token: {slack_token}")
        
        return drive_token, slack_token

# Run async delegation
import asyncio
drive_token, slack_token = asyncio.run(async_delegate_token())
```

## Resource Access with Context

Request access to specific user resources:

```python
from keycardai.oauth import Client

def access_user_resources():
    with Client("https://zoneid.keycard.cloud") as client:
        # Request access to user's Google Calendar
        calendar_token = client.get_access_token_for_resource(
            "https://www.googleapis.com/auth/calendar.readonly", 
            "user_access_token"
        )
        print(f"Calendar Access Token: {calendar_token}")
        
        # Request access to user's GitHub repos
        github_token = client.get_access_token_for_resource(
            "https://api.github.com", 
            "user_access_token"
        )
        print(f"GitHub Access Token: {github_token}")
        
        return calendar_token, github_token

# Run resource access
calendar_token, github_token = access_user_resources()
```

## Async Resource Access with Context

```python
from keycardai.oauth import AsyncClient

async def async_access_user_resources():
    async with AsyncClient("https://zoneid.keycard.cloud") as client:
        # Request access to user's Google Calendar
        calendar_token = await client.get_access_token_for_resource(
            "https://www.googleapis.com/auth/calendar.readonly", 
            "user_access_token"
        )
        print(f"Calendar Access Token: {calendar_token}")
        
        # Request access to user's GitHub repos
        github_token = await client.get_access_token_for_resource(
            "https://api.github.com", 
            "user_access_token"
        )
        print(f"GitHub Access Token: {github_token}")
        
        return calendar_token, github_token

# Run async resource access
import asyncio
calendar_token, github_token = asyncio.run(async_access_user_resources())
```


## Error Handling

```python
from keycardai.oauth import Client, OAuthError

def request_with_error_handling():
    with Client("https://zoneid.keycard.cloud") as client:
        try:
            access_token = client.get_access_token_for_resource(
                "https://api.example.com", 
                "user_access_token"
            )
            print("Token request successful!")
            print(f"Access Token: {access_token}")
            return access_token
            
        except OAuthError as e:
            print(f"OAuth error: {e}")
            # Handle OAuth specific errors
        except Exception as e:
            print(f"Unexpected error: {e}")

# Run with error handling
request_with_error_handling()
```

## Async Error Handling

```python
from keycardai.oauth import AsyncClient, OAuthError

async def async_request_with_error_handling():
    async with AsyncClient("https://zoneid.keycard.cloud") as client:
        try:
            access_token = await client.get_access_token_for_resource(
                "https://api.example.com", 
                "user_access_token"
            )
            print("Token request successful!")
            print(f"Access Token: {access_token}")
            return access_token
            
        except OAuthError as e:
            print(f"OAuth error: {e}")
            # Handle OAuth specific errors
        except Exception as e:
            print(f"Unexpected error: {e}")

# Run with async error handling
import asyncio
asyncio.run(async_request_with_error_handling())
```

## Common Use Cases

### 1. Scope Reduction
Exchange a token with broad permissions for one with limited scope:

```python
# Exchange admin token for read-only token
TokenExchangeRequest(
    grant_type=GrantType.TOKEN_EXCHANGE,
    subject_token="admin-token",
    subject_token_type=TokenType.ACCESS_TOKEN,
    scope="read-only"
)
```

### 2. Service-to-Service Communication
Exchange a user token for a service token:

```python
# Exchange user token for service communication
TokenExchangeRequest(
    grant_type=GrantType.TOKEN_EXCHANGE,
    subject_token="user-token",
    subject_token_type=TokenType.ACCESS_TOKEN,
    audience="internal-service",
    requested_token_type=TokenType.ACCESS_TOKEN
)
```

### 3. Cross-Domain Token Exchange
Exchange tokens between different domains or services:

```python
# Exchange token for different domain
TokenExchangeRequest(
    grant_type=GrantType.TOKEN_EXCHANGE,
    subject_token="source-domain-token",
    subject_token_type=TokenType.ACCESS_TOKEN,
    audience="target-domain.example.com",
    scope="cross-domain:access"
)
```

## Security Considerations

1. **Validate tokens** before exchange
2. **Limit scope** to minimum required permissions
3. **Use audience** to restrict token usage
4. **Monitor exchanges** for suspicious activity
5. **Set appropriate expiration** for exchanged tokens

For client registration examples, see the [Dynamic Client Registration guide](/examples/dynamic-client-registration).
